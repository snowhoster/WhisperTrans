# 音訊來源選擇與視覺化功能說明

## 功能概述

WhisperTrans.Desktop 現在支援：
1. **音訊來源選擇** - 可以選擇不同的麥克風或音訊輸入裝置
2. **音訊視覺化** - 即時顯示聲音波動狀態
3. **語音檢測指示器** - 視覺化顯示是否偵測到語音活動

## 主要功能

### 1. 音訊裝置選擇

#### 自動偵測裝置
- 應用程式啟動時會自動偵測所有可用的音訊輸入裝置
- 預設選擇系統預設的音訊裝置
- 裝置名稱旁會標示「(預設)」

#### 手動選擇裝置
1. 在「配置」區域找到「音訊來源」下拉選單
2. 選擇想要使用的音訊輸入裝置
3. 系統會顯示「已選擇音訊裝置: [裝置名稱]」

#### 重新整理裝置列表
- 點擊「?? 重新整理」按鈕可更新裝置列表
- 適用於錄音過程中新增或移除音訊裝置的情況
- 注意：必須在停止錄音的狀態下才能重新整理

### 2. 音訊監控面板

#### 裝置資訊顯示
在「音訊監控」區域可以看到：
- **?? 目前裝置** - 顯示當前選擇的音訊裝置名稱
- **?? 狀態** - 顯示目前的音訊狀態：
  - `待機中` - 尚未初始化
  - `就緒` - 已初始化，準備錄音
  - `錄音中` - 正在錄音
  - `靜音` - 未偵測到音訊
  - `偵測到音訊` - 偵測到聲音但非語音
  - `偵測到語音` - 偵測到人聲
  - `已停止` - 錄音已停止

#### 語音指示燈
- **綠色 ??** - 偵測到語音活動
- **橙色 ??** - 偵測到音訊但非語音
- **灰色 ?** - 靜音狀態

### 3. 音訊視覺化器

#### 波形顯示
- 即時顯示音訊波動狀態
- 使用 20 個動態條形圖表示聲音強度
- 採用正弦波模式創建流暢的視覺效果

#### 顏色指示
視覺化器會根據音訊狀態改變顏色：
- **綠色** - 偵測到語音（正常錄音狀態）
- **橙色** - 有聲音但非語音（背景雜音）
- **灰色** - 靜音狀態

#### 自動調整
- 波形會根據實際音量自動調整高度
- 錄音停止後，波形會逐漸降低並恢復靜音狀態

## 技術實作

### 新增的類別

#### 1. AudioDeviceInfo (Models)
```csharp
public class AudioDeviceInfo
{
    public int DeviceIndex { get; set; }
    public string DeviceName { get; set; }
    public string Manufacturer { get; set; }
    public int Channels { get; set; }
    public bool IsDefault { get; set; }
    public string DisplayName { get; }
}
```

#### 2. AudioLevelEventArgs (Models)
```csharp
public class AudioLevelEventArgs : EventArgs
{
    public float Level { get; set; }          // 0.0 - 1.0
    public float PeakLevel { get; set; }      // 0.0 - 1.0
    public bool IsSpeechDetected { get; set; }
    public DateTime Timestamp { get; set; }
}
```

#### 3. AudioVisualizer (Controls)
```csharp
public class AudioVisualizer : UserControl
{
    public float AudioLevel { get; set; }
    public float PeakLevel { get; set; }
    public bool IsSpeechDetected { get; set; }
}
```

### NAudioCapture 更新

#### 新增方法
```csharp
// 設定音訊輸入裝置
public void SetDevice(int deviceNumber)

// 取得可用的音訊輸入裝置列表
public static List<AudioDeviceInfo> GetAvailableDevices()
```

#### 新增事件
```csharp
public event EventHandler<AudioLevelEventArgs>? AudioLevelChanged;
```

#### 音訊層級計算
- 使用 RMS（均方根）方法計算音量
- 即時追蹤峰值音量
- 整合 VAD（語音活動檢測）判斷是否為人聲

## 使用流程

### 基本使用

1. **啟動應用程式**
   - 系統自動偵測並載入可用的音訊裝置
   - 預設選擇第一個裝置

2. **選擇音訊來源**（可選）
   - 從「音訊來源」下拉選單選擇所需裝置
   - 觀察「目前裝置」欄位確認選擇

3. **配置其他設定**
   - 選擇或下載 Whisper 模型
   - 設定語言、GPU 加速等選項

4. **初始化系統**
   - 點擊「初始化」按鈕
   - 等待系統初始化完成

5. **開始錄音**
   - 點擊「?? 開始錄音」按鈕
   - 觀察音訊視覺化器和狀態指示器
   - 系統會即時轉錄語音

6. **監控音訊**
   - 觀察波形視覺化確認音訊輸入正常
   - 綠色指示燈表示正在偵測語音
   - 狀態文字顯示目前的音訊狀態

### 疑難排解

#### 問題：未偵測到音訊裝置
**解決方案：**
1. 確認麥克風已正確連接
2. 檢查系統音訊設定中麥克風是否啟用
3. 點擊「?? 重新整理」按鈕
4. 重新啟動應用程式

#### 問題：視覺化器沒有反應
**解決方案：**
1. 確認已點擊「開始錄音」按鈕
2. 檢查是否選擇了正確的音訊裝置
3. 測試麥克風是否正常工作（在系統設定中測試）
4. 確認麥克風音量未被靜音

#### 問題：無法偵測到語音
**解決方案：**
1. 調整麥克風音量（增加輸入音量）
2. 確認「啟用語音活動檢測 (VAD)」已勾選
3. 靠近麥克風並清楚說話
4. 檢查環境是否過於吵雜

#### 問題：切換裝置後無法錄音
**解決方案：**
1. 停止目前的錄音
2. 重新初始化系統
3. 再次開始錄音

## 效能考量

### CPU 使用率
- 音訊視覺化器使用 50ms 更新間隔
- 對 CPU 影響極小（< 1%）

### 記憶體使用
- 音訊緩衝區大小固定
- 不會隨錄音時間增長而增加記憶體使用

### 延遲
- 音訊視覺化延遲 < 100ms
- 不影響實際的語音轉錄效能

## 進階設定

### 自訂 VAD 閾值
在初始化時可以調整 VAD 閾值：
```csharp
var config = new WhisperConfig
{
    VadThreshold = 0.02f,  // 預設值，可調整 0.01-0.1
    MinSilenceDurationMs = 500
};
```

### 調整視覺化器更新頻率
修改 `MainWindow.xaml.cs` 中的 timer 間隔：
```csharp
_visualizerTimer = new DispatcherTimer
{
    Interval = TimeSpan.FromMilliseconds(50)  // 可調整 20-100
};
```

## API 參考

### GetAvailableDevices()
取得所有可用的音訊輸入裝置列表。

**回傳值：**
- `List<AudioDeviceInfo>` - 裝置資訊列表

**範例：**
```csharp
var devices = NAudioCapture.GetAvailableDevices();
foreach (var device in devices)
{
    Console.WriteLine($"{device.DeviceIndex}: {device.DisplayName}");
}
```

### SetDevice(int deviceNumber)
設定要使用的音訊輸入裝置。

**參數：**
- `deviceNumber` - 裝置索引（-1 表示預設裝置）

**範例：**
```csharp
_audioCapture.SetDevice(1);  // 使用索引 1 的裝置
```

### AudioLevelChanged 事件
當音訊層級變化時觸發。

**事件參數：**
- `Level` - 當前音量 (0.0-1.0)
- `PeakLevel` - 峰值音量 (0.0-1.0)
- `IsSpeechDetected` - 是否偵測到語音

**範例：**
```csharp
_audioCapture.AudioLevelChanged += (sender, e) =>
{
    Console.WriteLine($"音量: {e.Level:P0}, 語音: {e.IsSpeechDetected}");
};
```

## 常見問題 FAQ

### Q: 可以同時使用多個音訊裝置嗎？
A: 目前版本每次只能使用一個音訊裝置。如需同時錄製多個來源，請啟動多個應用程式實例。

### Q: 視覺化器支援雙聲道嗎？
A: 當前實作使用單聲道（mono），雙聲道會被混合成單聲道處理。

### Q: 如何選擇虛擬音訊裝置（如 VB-Cable）？
A: 虛擬音訊裝置會出現在裝置列表中，可直接選擇。這對於錄製系統音訊或其他應用程式的輸出很有用。

### Q: 音訊視覺化會影響轉錄精確度嗎？
A: 不會。視覺化和轉錄是獨立運作的，視覺化器只是讀取音訊資料，不會修改或影響轉錄流程。

### Q: 可以自訂視覺化器的顏色嗎？
A: 可以修改 `AudioVisualizer.cs` 中的 `UpdateBarColors()` 方法來自訂顏色方案。

## 更新日誌

### v1.1.0
- ? 新增音訊裝置選擇功能
- ? 新增即時音訊視覺化器
- ? 新增語音檢測指示燈
- ? 新增裝置資訊顯示
- ? 新增音訊狀態監控
- ?? 更新 NAudioCapture 支援裝置選擇
- ?? 新增 AudioLevelChanged 事件
- ?? 新增 AudioDeviceInfo 和 AudioLevelEventArgs 模型

## 相關資源

- [NAudio 官方文件](https://github.com/naudio/NAudio)
- [Whisper.cpp 模型](https://huggingface.co/ggerganov/whisper.cpp)
- [語音活動檢測 (VAD)](https://en.wikipedia.org/wiki/Voice_activity_detection)
